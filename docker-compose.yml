version: '3.9'

x-saka-service: &saka-service
  restart: unless-stopped
  build:
    context: .
    dockerfile: Dockerfile.agent
  networks:
    - saka_net
  env_file:
    - .env
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
    interval: 10s
    timeout: 5s
    retries: 5
    start_period: 20s

services:
  orchestrator:
    <<: *saka-service
    container_name: saka_orchestrator
    ports:
      - "8080:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      kamila_ceo: { condition: service_healthy }
      sentinel_risk: { condition: service_healthy }
      aethertrader_manager: { condition: service_healthy }
      cronos_cycles: { condition: service_healthy }
      orion_cfo: { condition: service_healthy }
    command: uvicorn saka.orchestrator.main:app --host 0.0.0.0 --port 8000 --reload

  kamila_ceo:
    <<: *saka-service
    container_name: saka_kamila_ceo
    depends_on:
      sentinel_risk: { condition: service_healthy }
      aethertrader_manager: { condition: service_healthy }
    command: uvicorn saka.agents.kamila_ceo.main:app --host 0.0.0.0 --port 8000 --reload

  sentinel_risk:
    <<: *saka-service
    container_name: saka_sentinel_risk
    command: uvicorn saka.agents.sentinel_risk.main:app --host 0.0.0.0 --port 8000 --reload

  aethertrader_manager:
    <<: *saka-service
    container_name: saka_aethertrader_manager
    command: uvicorn saka.agents.aethertrader_manager.main:app --host 0.0.0.0 --port 8000 --reload

  cronos_cycles:
    <<: *saka-service
    container_name: saka_cronos_cycles
    command: uvicorn saka.agents.cronos_cycles.main:app --host 0.0.0.0 --port 8000 --reload

  orion_cfo:
    <<: *saka-service
    container_name: saka_orion_cfo
    command: uvicorn saka.agents.orion_cfo.main:app --host 0.0.0.0 --port 8000 --reload

networks:
  saka_net:
    driver: bridge